name: Build Jetson ONLINE

on: [push]

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
 
      - name: Checkout repository and submodules
        uses: actions/checkout@v3
        with:
          submodules: recursive   

      - name: Emulating Jetson
        id: push
        uses: pguyot/arm-runner-action@f204b58258d5b01e297eec6db036a14b11dc9ffa
        with:
          base_image: http://openhdfpv.org/wp-content/BaseImages/Open.HD-2.1-05221841-jetson-nano-4gb-bionic.img.zip
          cpu: cortex-a53
          bootpartition:
          rootpartition: 1
          image_additional_mb: 20000
          copy_repository_path: /opt
          copy_artifact_path: qt-raspberry
          import_github_env: true
          commands: |
            cd /opt/qt-raspberry
            sudo ./build.sh jetson-nano
            sudo ./package.sh jetson-nano bionic

      - name: Upload to Github
        uses: 'actions/upload-artifact@v2'
        with:
          name: "qt"
          path: |
            qt-raspberry/*.deb
        
      - name: Push to Cloudsmith
        id: cloudsmith push
        uses: cloudsmith-io/action@master
        with:
          api-key: ${{ secrets.CLOUDSMITH_API_KEY }}
          command: "push"
          format: "deb"
          owner: "openhd"
          repo: "openhd-2-1-alpha"
          distro: "ubuntu"
          release: "bionic"
          republish: "true" # needed ONLY if version is not changing
          file: "qt-raspberry/*.deb"

      #- name: Install
      #  run: |
      #    cd OpenHD/build
      #    sudo cmake --install .
      #- name: Build ninja
      #  run: |
      #    sudo apt -y install ninja-build
      #    cd OpenHD
      #    ./build_cmake.sh
